<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:title" content="Fill IRS Form 8949 with CSV">
  <meta property="og:description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://fill-8949.ardis.lu/">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="icon" href="data:,">
  <link rel="preload" href="https://rsms.me/inter/font-files/InterVariable.woff2?v=4.1" crossorigin as="font">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/tslib@1.14.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pako@1.0.11/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/standard-fonts@1.0.0/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/upng@1.0.1/+esm">
  <title>Fill IRS Form 8949 with CSV</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #dbeafe;
      --secondary: #f8fafc;
      --text: #0f172a;
      --text-light: #475569;
      --background: #f1f5f9;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
      --transition: 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    @supports (font-variation-settings: normal) {
      :root {
        font-family: 'Inter var', sans-serif;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.6;
    }

    .container {
      width: min(900px, 100%);
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
    }

    header p {
      color: var(--text-light);
      font-size: 1.1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin-bottom: 2rem;
      width: 100%;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h2 svg {
      width: 1.5rem;
      height: 1.5rem;
    }

    .disclaimer, .privacy {
      background-color: var(--primary-light);
      padding: 1rem;
      border-radius: var(--radius);
      border-left: 4px solid var(--primary);
      margin-bottom: 1rem;
    }

    .disclaimer b, .privacy b {
      color: var(--primary-dark);
      display: block;
      margin-bottom: 0.25rem;
    }

    .steps {
      margin: 1.5rem 0;
      counter-reset: step;
    }

    .step {
      display: flex;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .step:last-child {
      margin-bottom: 0;
    }

    .step-number {
      background-color: var(--primary);
      color: white;
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
      margin-right: 1rem;
    }

    .step-content {
      padding-top: 0.25rem;
    }

    .template-link {
      display: inline-flex;
      align-items: center;
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      gap: 0.25rem;
      margin: 0 0.25rem;
      transition: var(--transition);
    }

    .template-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .template-link svg {
      width: 1rem;
      height: 1rem;
    }

    form {
      display: grid;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    label svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    select, input[type="file"] {
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      width: 100%;
      background-color: var(--secondary);
      transition: var(--transition);
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23475569'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
    }

    input[type="file"] {
      padding: 0.5rem;
    }

    input[type="file"]::file-selector-button {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border: none;
      background-color: var(--primary-light);
      color: var(--primary-dark);
      border-radius: var(--radius);
      margin-right: 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    input[type="file"]::file-selector-button:hover {
      background-color: var(--primary);
      color: white;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 4px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    button {
      padding: 0.75rem 1.5rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: auto;
      margin: 0 auto;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    button:disabled {
      background-color: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    .spinner {
      display: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .github-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-top: 1rem;
      transition: var(--transition);
    }

    .github-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .github-link svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    footer {
      margin-top: 2rem;
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .card {
        padding: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>IRS Form 8949 Filler</h1>
      <p>Generate tax forms from your CSV data in seconds</p>
    </header>

    <section class="card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
          <path d="M13 2v7h7"></path>
        </svg>
        About This Tool
      </h2>

      <div class="disclaimer">
        <b>Disclaimer</b>
        The author of this tool is not responsible for any errors or omissions, or for the results obtained from the use of this tool. All outputs are provided "as is", with no guarantee of completeness, accuracy, or of the results obtained from the use of this tool, and without warranty of any kind. The output from this tool is provided with the understanding that the author is not herein engaged in rendering legal, accounting, tax, or other professional advice and services.
      </div>

      <div class="privacy">
        <b>Privacy</b>
        The CSV parsing and PDF filling operations occur entirely in your web browser. Your CSV data does not leave your computer.
      </div>

      <a href="https://github.com/ardislu/fill-8949-with-csv" class="github-link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
        </svg>
        View Source Code on GitHub
      </a>
    </section>

    <section class="card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        How It Works
      </h2>

      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            Download two copies of the CSV template
            <a id="template-link" href="#" class="template-link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              template.csv
            </a>
          </div>
        </div>

        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            Fill the templates with data to populate the tables on page 1 (short-term transactions) and page 2 (long-term transactions) of
            <a href="https://www.irs.gov/form8949" target="_blank" class="template-link">
              IRS Form 8949
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </a>
          </div>
        </div>

        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            Select the filled CSV templates in the form below
          </div>
        </div>

        <div class="step">
          <div class="step-number">4</div>
          <div class="step-content">
            Click "Download Filled Form 8949" to generate and download your completed tax form
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="8" y1="12" x2="16" y2="12"></line>
          <line x1="12" y1="8" x2="12" y2="16"></line>
        </svg>
        Generate Your Form
      </h2>

      <form>
        <div class="form-group">
          <label for="year">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Tax Year
          </label>
          <select id="year" name="year">
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
          </select>
        </div>

        <div class="form-group">
          <label for="short">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Short-term Transactions CSV
          </label>
          <input type="file" id="short" name="short" accept="text/csv" required>
        </div>

        <div class="form-group">
          <label for="long">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Long-term Transactions CSV
          </label>
          <input type="file" id="long" name="long" accept="text/csv" required>
        </div>

        <div class="form-group checkbox-group">
          <input type="checkbox" id="headers" name="headers" checked>
          <label for="headers">Data has headers</label>
        </div>

        <button type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download Filled Form 8949
          <span class="spinner"></span>
        </button>
      </form>
    </section>
  </div>

  <footer>
    &copy; 2025 Fill IRS Form 8949 with CSV. All rights reserved.
  </footer>

  <script type="module">
    import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
    import { PDFArray, PDFDict, PDFDocument, PDFName, PDFString, PDFBool } from 'https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm'; // Added PDFBool

    const button = document.querySelector('button');
    const spinner = document.querySelector('.spinner');

    // Use a custom id generator instead of crypto.randomUUID() to reduce PDF file size
    const annotationIds = (function* () {
      let i = 0;
      while (true) {
        yield `f${i}`; // Must be unique within the PDF
        i++;
      }
    })();

    // Duplicate all annotations exactly, except for the "T" key. The "T" key ("text label") is used
    // as a unique identifier for the annotation and must be updated or else all annotations with
    // the same "T" key will have the same value.
    // Original code from: https://github.com/Hopding/pdf-lib/issues/151
    function cloneAnnotations(page) {
      const form = page.doc.catalog.lookup(PDFName.of('AcroForm'), PDFDict);
      if (!form) return; // Exit if no AcroForm found
      const fields = form.lookup(PDFName.of('Fields'), PDFArray);
      if (!fields) return; // Exit if no Fields array found

      const annotations = page.node.Annots();
      if (!annotations) return; // Exit if no Annots found

      for (let i = 0; i < annotations.size(); i++) {
        const annotRef = annotations.get(i);
        const annotDict = annotations.lookupMaybe(i, PDFDict);

        // Ensure it's a widget annotation and has a /T key
        if (annotDict && annotDict.get(PDFName.of('Subtype')) === PDFName.of('Widget') && annotDict.has(PDFName.of('T'))) {
           // Check if this annotation reference is already in the Fields array to avoid duplication
           let alreadyInFields = false;
           for (let j=0; j < fields.size(); j++) {
             if (fields.get(j) === annotRef) {
                alreadyInFields = true;
                break;
             }
           }
           
           // If not already in main Fields array, clone, give unique T, and add.
           if (!alreadyInFields) {
              const clonedAnnotDict = annotDict.clone(page.doc.context);
              clonedAnnotDict.set(PDFName.of('T'), PDFString.of(annotationIds.next().value));
              // Add the *reference* to the cloned dictionary to the Fields array.
              // Note: This assumes cloning automatically registers the new object and gives it a ref.
              // If pdf-lib's clone doesn't auto-register, we might need pdfDoc.context.register(clonedAnnotDict)
              // before pushing the reference. Let's assume it does for now as per typical design.
              const clonedAnnotRef = page.doc.context.register(clonedAnnotDict);
              fields.push(clonedAnnotRef); 
           } else {
             // If it *is* in the Fields array, we might still need a unique ID if multiple pages
             // reference the *same* original field definition but need independent values.
             // This part is tricky - simply setting T might not be enough if the original field is shared.
             // A safer approach for truly independent fields might be restructuring how fields are added/cloned.
             // For now, let's stick to the original goal of adding copies unique *per page*.
             // If the *same* field ref is used on *multiple* copied pages, they might still link.
             // The `annotationIds.next().value` ensures each *widget annotation instance* on the page gets a new T key.
             annotDict.set(PDFName.of('T'), PDFString.of(annotationIds.next().value));
           }
        }
      }
    };

    async function generatePage(f8949, data, type) {
      // Determine source page index based on type
      const sourcePageIndex = type === 'short' ? 0 : 1;
      
      // Get the original page *once* per type to avoid repeated lookups if possible
      // This assumes f8949 contains the original template pages at indices 0 and 1
      const originalPage = f8949.getPage(sourcePageIndex);
    
      // Copy the determined page
      const [page] = await f8949.copyPages(f8949, [sourcePageIndex]);
      
      // Clone annotations specific to THIS newly copied page
      cloneAnnotations(page);

      let cellNumber = 0;
      // Offset might vary depending on exact form structure; 5 was the original value
      const offset = 5; 
      
      // Get annotations *from the newly copied page*
      const annots = page.node.Annots(); 
      if (!annots) return page; // Return unmodified page if no annotations

      // Populate the fields on the copied page
      for (const row of data) {
        for (const cell of row) {
          const annotIndex = cellNumber + offset;
          // Use lookupMaybe to avoid errors if index is out of bounds
          const a = annots.lookupMaybe(annotIndex, PDFDict); 
          if (a && a.get(PDFName.of('Subtype')) === PDFName.of('Widget')) { // Check if it's a widget field
              a.set(PDFName.of('V'), PDFString.of(String(cell))); // Ensure cell is string
              a.set(PDFName.of('Ff'), PDFString.of('0')); // Optionally reset flags if needed, e.g., clear ReadOnly if set
              // We might need to update the appearance stream (/AP) as well, but
              // setting NeedAppearances = true on the AcroForm should handle this globally.
          } else {
              console.warn(`Annotation at index ${annotIndex} not found or not a widget on ${type} page.`);
          }
          cellNumber++;
        }
      }

      return page;
    }

    async function generate8949(f8949Bytes, year, shortData, longData) {
      const f8949 = await PDFDocument.load(f8949Bytes, { 
          // Option to ignore minor errors during loading if needed
          // ignoreEncryption: true, 
          // updateFieldAppearances: true // Let pdf-lib try to update appearances
      });

      // --- XFA Removal Start ---
      try {
          const form = f8949.getForm();
          const acroFormDict = form?.catalog?.lookup(PDFName.of('AcroForm'), PDFDict);

          if (acroFormDict?.has(PDFName.of('XFA'))) {
              console.log("XFA found, removing...");
              acroFormDict.delete(PDFName.of('XFA'));
              
              // Set NeedAppearances to true - crucial for non-XFA viewers
              acroFormDict.set(PDFName.of('NeedAppearances'), PDFBool.True);
              console.log("XFA removed and NeedAppearances set.");
          } else {
              console.log("No XFA field found in AcroForm.");
              // Even if no XFA, setting NeedAppearances might be beneficial
              if (acroFormDict) {
                 acroFormDict.set(PDFName.of('NeedAppearances'), PDFBool.True);
                 console.log("NeedAppearances set (no XFA found).");
              }
          }
      } catch (error) {
        console.error("Error accessing or modifying AcroForm:", error);
        // Decide how to handle: maybe continue without removal, maybe throw error
      }
      // --- XFA Removal End ---

      const pagePromises = [];
      const chunkSize = 14; // Rows per page in the form

      // Generate short-term pages
      for (let i = 0; i < shortData.length; i += chunkSize) {
        const chunk = shortData.slice(i, i + chunkSize);
        pagePromises.push(generatePage(f8949, chunk, 'short'));
      }
      // Add a blank short-term page if no short-term data
      if (shortData.length === 0) { 
        console.log("No short term data, adding blank page 1 template.");
        pagePromises.push(
          f8949.copyPages(f8949, [0]).then(pages => {
             const blankPage = pages[0];
             cloneAnnotations(blankPage); // Ensure fields are independent even on blank pages
             return blankPage;