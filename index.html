<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:title" content="Fill IRS Form 8949 with CSV">
  <meta property="og:description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://form8949.urz.one/">

  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/tslib@1.14.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pako@1.0.11/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/standard-fonts@1.0.0/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/upng@1.0.1/+esm">
  <title>Fill IRS Form 8949 with CSV</title>
  <style>
    /* CSS Styles remain the same as provided previously */
    :root {
      --primary: #1a4d7c;
      --primary-light: #2975b9;
      --primary-dark: #0f3155;
      --secondary: #f8f9fa;
      --accent: #4cc9f0;
      --text: #333;
      --text-light: #6c757d;
      --success: #28a745;
      --error: #dc3545;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    @supports (font-variation-settings: normal) {
      :root {
        font-family: 'Inter var', sans-serif;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.6;
    }

    .container {
      width: min(1000px, 100%);
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary);
      line-height: 1.2;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 2rem;
      margin-bottom: 2rem;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .disclaimer, .privacy {
      background: #f8f9fa;
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin: 1.5rem 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }

    .disclaimer b, .privacy b {
      color: var(--primary);
      display: block;
      margin-bottom: 0.5rem;
    }

    .steps {
      counter-reset: step;
      margin: 2rem 0;
    }

    .step {
      display: flex;
      margin-bottom: 1.5rem;
      padding: 0 0 0 3rem;
      position: relative;
    }

    .step:before {
      counter-increment: step;
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      background: var(--primary);
      color: white;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .form-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--primary-dark);
    }

    select, input[type="file"] {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      background-color: #fff;
      transition: var(--transition);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231a4d7c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      padding-right: 2.5rem;
    }

    input[type="file"] {
      padding: 0.5rem;
    }

    input[type="file"]::file-selector-button {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      border-radius: var(--border-radius);
      background-color: var(--secondary);
      border: 1px solid #ced4da;
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
    }

    input[type="file"]::file-selector-button:hover {
      background-color: #e2e6ea;
    }

    .checkbox-group, .radio-group {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .radio-group {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
    }

    input[type="checkbox"], input[type="radio"] {
      margin-right: 0.5rem;
      width: 1.25rem;
      height: 1.25rem;
      accent-color: var(--primary);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background-color: var(--primary-light);
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    [data-submitting] button {
      cursor: not-allowed;
      background-color: var(--text-light);
      opacity: 0.7;
      transform: none;
    }

    .button-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 1rem;
    }

    .download-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
      transition: var(--transition);
    }

    .download-link:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .download-link svg {
      transition: var(--transition);
    }

    .download-link:hover svg {
      transform: translateY(2px);
    }

    .source {
      margin-top: 1.5rem;
      text-align: center;
    }

    .source a {
      color: var(--primary);
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .source a:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    .spinner {
      display: none;
      width: 1.5rem;
      height: 1.5rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 0.75rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    footer {
      margin-top: 3rem;
      text-align: center;
      color: var(--text-light);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .card, .form-container {
        padding: 1.5rem;
      }

      h1 {
        font-size: 2rem;
      }

      .step {
        padding-left: 2.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>IRS Form 8949 Filler</h1>
      <p class="subtitle">Easily fill IRS Form 8949 with your CSV data</p>
    </header>

    <section class="card">
      <div class="disclaimer">
        <b>Disclaimer</b>
        <p>The author of this tool is not responsible for any errors or omissions, or for the results obtained from the use of this tool. All outputs are provided "as is", with no guarantee of completeness, accuracy, or of the results obtained from the use of this tool, and without warranty of any kind. The output from this tool is provided with the understanding that the author is not herein engaged in rendering legal, accounting, tax, or other professional advice and services.</p>
      </div>

      <div class="privacy">
        <b>Privacy</b>
        <p>The CSV parsing and PDF filling operations occur in your web browser. Your CSV data does not leave your computer.</p>
      </div>
    </section>

    <div class="form-container">
      <div class="steps">
        <div class="step">
          <div>
            <h3>Download CSV Templates</h3>
            <p>Download two copies of the CSV template for short-term and long-term transactions.</p>
            <a href="#" id="template-link" class="download-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              template.csv
            </a>
          </div>
        </div>

        <div class="step">
          <div>
            <h3>Fill the Templates</h3>
            <p>Fill the templates with data to populate the tables on page 1 (short-term transactions) and page 2 (long-term transactions) of <a href="https://www.irs.gov/form8949" target="_blank">IRS Form 8949</a>.</p>
          </div>
        </div>

        <div class="step">
          <div>
            <h3>Upload and Generate</h3>
            <p>Select the filled CSV templates and click "Generate Filled Form" to download your customized IRS Form 8949.</p>
          </div>
        </div>
      </div>

      <form>
        <div class="form-group">
          <label for="year">Tax Year</label>
          <select id="year" name="year">
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
          </select>
        </div>

        <div class="form-group">
          <label for="short">Short-term Transactions CSV</label>
          <input type="file" id="short" name="short" accept="text/csv" required>
        </div>

        <div class="form-group">
          <label for="long">Long-term Transactions CSV</label>
          <input type="file" id="long" name="long" accept="text/csv" required>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="headers" name="headers" checked>
          <label for="headers">CSV data has headers</label>
        </div>

        <div class="form-group">
          <label>Output Format</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="format-form" name="format" value="form" checked>
              <label for="format-form">Form with Fields (Editable)</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="format-static" name="format" value="static">
              <label for="format-static">Static PDF (Compatible with all viewers)</label>
            </div>
          </div>
        </div>

        <div class="button-container">
          <button type="submit">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Generate Filled Form
          </button>
          <div class="spinner"></div>
        </div>

        <div class="source">
          <a href="https://github.com/ardislu/fill-8949-with-csv" target="_blank">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            View source code on GitHub
          </a>
        </div>
      </form>
    </div>

    <footer>
      <p>&copy; 2025 IRS Form 8949 Filler Tool</p> <!-- Note: Year might need update -->
    </footer>
  </div>

  <script type="module">
    import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
    // Import necessary classes from pdf-lib
    import { PDFDocument, PDFName /* , PDFArray, PDFDict, PDFString - Not needed currently */ } from 'https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm';

    // Get references to DOM elements
    const button = document.querySelector('button');
    const spinner = document.querySelector('.spinner');
    const formElement = document.querySelector('form'); // Reference the form element

    // --- Updated Page Filling Logic ---
    // Fills data into the fields of a specific page using the discovered naming pattern
    async function fillPageData(page, data, termType) { // Added termType ('short' or 'long')
       const form = page.doc.getForm();
       if (!form) {
           console.error('Cannot fill data: Form object not found on page associated with the final document.');
           return; // Cannot proceed
       }

       const rowsPerPage = 14; // Assumed rows per page in the template
       const fieldsPerRow = 8; // Expected number of data columns per row

        // --- Determine PDF structure parts based on termType ---
       const pageNum = (termType === 'short') ? 1 : 2; // *** ASSUMPTION: Long-term uses Page2 ***
       const fieldBase = (termType === 'short') ? 'f1' : 'f2'; // *** ASSUMPTION: Long-term uses f2_ prefix ***
       const basePath = `topmostSubform[0].Page${pageNum}[0].Table_Line1[0].`;

       // --- Initial field indices for columns 0-7 ---
       // *** VERIFY THESE BY INSPECTING YOUR PDF TEMPLATE ***
       const initialIndices = [3, 4, 5, 6, 7, 8, 9, 10]; // Col 0 starts at 3, assuming others increment

       console.log(`Filling data for ${termType} (Page ${pageNum}, Base ${fieldBase}) using basePath: ${basePath}`);

       for (let r = 0; r < data.length && r < rowsPerPage; r++) { // r is 0-based row index
           const rowData = data[r];
           const rowNum = r + 1; // PDF Row number is 1-based (Row1, Row2...)

           for (let c = 0; c < rowData.length && c < fieldsPerRow; c++) { // c is 0-based column index
               const cellValue = String(rowData[c] || ''); // Get cell value, ensure string

               if (c >= initialIndices.length) {
                    console.warn(`[Row ${rowNum}] Skipping column index ${c} - no initial index defined.`);
                   continue;
               }

               // Calculate the specific index for this field
               const initialIndex = initialIndices[c];
               if (typeof initialIndex !== 'number') {
                    console.warn(`[Row ${rowNum}, Col ${c}] Invalid initial index: ${initialIndex}`);
                   continue; // Skip if the initial index is bad
               }
               const calculatedIndex = initialIndex + (r * 8); // Add 8 for each row offset

               // Construct the full field name
               const fieldName = `${basePath}Row${rowNum}[0].${fieldBase}_${calculatedIndex}[0]`;

               try {
                   // Use getTextField, assuming all table cells are text fields
                   // In the future, might need getCheckBox, getRadioGroup, etc. if applicable
                   const field = form.getTextField(fieldName);
                   field.setText(cellValue);
                    // console.log(`[Row ${rowNum}, Col ${c}] Set field "${fieldName}" to: ${cellValue}`); // Uncomment for intense debugging

               } catch (e) {
                   // This error is CRITICAL if field names are wrong
                   console.warn(`!! FAILED to find/set field: "${fieldName}". Check PDF template naming pattern/assumptions (Page, Base, Initial Index). Error: ${e.message}`);
               }
           }
       }
        console.log(`Finished filling data attempt for ${termType}, page ${pageNum}. Check warnings above for issues.`);
   }

    // --- Main PDF Generation Logic (generate8949) ---
    // Generates the final PDF (either fillable or flattened static)
    async function generate8949(f8949Bytes, year, shortData, longData, isStatic = false) {
       const sourceDoc = await PDFDocument.load(f8949Bytes);
       const finalDoc = await PDFDocument.create(); // Create the target document we'll build
       const chunkSize = 14; // Assumed rows per page in the template

       // Process Short-Term Data
       console.log(`Processing ${shortData.length} short-term rows...`);
       if (shortData.length > 0) {
           for (let i = 0; i < shortData.length; i += chunkSize) {
               const chunk = shortData.slice(i, i + chunkSize);
               console.log(`   Copying short-term template page (index 0) for rows ${i+1}-${Math.min(i+chunkSize, shortData.length)}`);
               const [copiedPage] = await finalDoc.copyPages(sourceDoc, [0]); // Copy template page 0
               finalDoc.addPage(copiedPage);
               // Fill data for 'short' term
               await fillPageData(copiedPage, chunk, 'short'); // Pass 'short'
           }
       } else {
           // Add a blank short-term page if no data
           console.log("No short-term data, adding blank template page (index 0).");
           const [copiedPage] = await finalDoc.copyPages(sourceDoc, [0]);
           finalDoc.addPage(copiedPage);
       }

       // Process Long-Term Data
       console.log(`Processing ${longData.length} long-term rows...`);
       if (longData.length > 0) {
           for (let i = 0; i < longData.length; i += chunkSize) {
               const chunk = longData.slice(i, i + chunkSize);
               console.log(`   Copying long-term template page (index 1) for rows ${i+1}-${Math.min(i+chunkSize, longData.length)}`);
               const [copiedPage] = await finalDoc.copyPages(sourceDoc, [1]); // Copy template page 1
               finalDoc.addPage(copiedPage);
               // Fill data for 'long' term
               await fillPageData(copiedPage, chunk, 'long'); // Pass 'long'
           }
       } else {
           // Add a blank long-term page if no data
           console.log("No long-term data, adding blank template page (index 1).");
           const [copiedPage] = await finalDoc.copyPages(sourceDoc, [1]);
           finalDoc.addPage(copiedPage);
       }

      // --- Flatten if Static PDF is requested ---
      if (isStatic) {
        console.log("Flattening PDF...");
        try {
            const form = finalDoc.getForm();
            if (form) {
                // Crucial: Ensure field appearances are generated *before* flattening
                 form.updateFieldAppearances(); // Update appearances based on filled values
                 // Now flatten. updateFieldAppearances: true here can sometimes cause issues,
                 // so set it to false as we've already updated them.
                 form.flatten({ updateFieldAppearances: false });
                 console.log("Flattening complete.");
             } else {
                 console.warn("No form found in the document to flatten.");
                 // This might happen if the template truly has no AcroForm, but unlikely for IRS forms.
             }
        } catch (flattenError) {
             console.error("Error during flattening:", flattenError);
            // Consider more robust error reporting or fallback
             alert(`Warning: Could not flatten the PDF. The downloaded file might still be editable or incomplete. Error: ${flattenError.message}`);
             // Proceed to save the filled (but not flattened) attempt
        }
      } else {
          // For fillable forms, ensure NeedAppearances flag is set if fields were modified
          try {
              const form = finalDoc.getForm();
              if(form && form.acroForm) { // Check if acroForm exists
                  // Set the flag to ensure viewer recalculates appearances if needed
                  form.acroForm.dict.set(PDFName.of('NeedAppearances'), finalDoc.context.obj(true));
                  // Optionally update appearances immediately for the fillable form too? Test if helpful.
                  // form.updateFieldAppearances();
              } else if (form) {
                  console.warn("Form exists, but AcroForm dictionary not found. Cannot set NeedAppearances.")
              }
          } catch(e) {
              console.warn("Could not get form or set NeedAppearances flag.", e);
          }
      }

      // Define filename based on output type
      const filename = `f8949_${year}_${isStatic ? 'static' : 'filled'}.pdf`;
      console.log(`Saving PDF as: ${filename}`);

      // Save the final document
      // We might not need updateFieldAppearances here if done previously, especially for static. Test effects.
      return finalDoc.save({ updateFieldAppearances: !isStatic }).then(data =>
          new File([data.buffer], filename, { type: 'application/pdf' })
      );
    }

    // --- Helper Functions ---
    // Triggers browser download for a file object
    function download(file) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(file);
      a.download = file.name;
      document.body.appendChild(a); // Append anchor to body
      a.click();
      document.body.removeChild(a); // Clean up
      URL.revokeObjectURL(a.href); // Release object URL
    }

    // Parses a CSV file using PapaParse
    async function parseCsv(file, hasHeaders) {
      return new Promise((resolve, reject) => {
        if (!file || !(file instanceof File)) {
           return reject(new Error("Invalid file provided for parsing."));
        }
        Papa.parse(file, {
          header: false, // We handle headers manually if present
          skipEmptyLines: 'greedy',
          complete: (results) => {
              if (results.errors && results.errors.length > 0) {
                 console.error("CSV Parsing Errors:", results.errors);
                 return reject(new Error(`CSV Parsing Error (${results.errors[0].code}): ${results.errors[0].message} on row ${results.errors[0].row + (hasHeaders ? 1 : 0)}`));
              }
              let data = results.data;
              if (hasHeaders && data.length > 0) {
                data.shift(); // Remove header row
              }
              // Standardize row length (ensure 8 columns)
              const expectedColumns = 8;
              const standardizedData = data
                 .filter(row => Array.isArray(row) && row.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '')) // Filter out functionally empty rows
                 .map(row => {
                    const newRow = [...row];
                    while (newRow.length < expectedColumns) {
                        newRow.push(''); // Pad with empty strings
                    }
                    return newRow.slice(0, expectedColumns); // Truncate if too long
               });
              resolve(standardizedData);
          },
          error: (error) => {
              console.error("PapaParse Error:", error);
              reject(error);
          }
        });
      });
    }

    // --- Event Listeners ---
    // Template Download Link
    document.querySelector('#template-link').addEventListener('click', e => {
      e.preventDefault();
      const csv = '"Description of property","Date acquired","Date sold or disposed of","Proceeds (sales price)","Cost or other basis","Code(s) from instructions","Amount of adjustment","Gain or (loss)"';
      const encoded = new TextEncoder().encode(csv);
      const file = new File([encoded], 'template.csv', { type: 'text/csv;charset=utf-8' });
      download(file);
    });

    // Form Submission Handler
    formElement.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (formElement.hasAttribute('data-submitting')) {
        return;
      }
      formElement.setAttribute('data-submitting', '');
      spinner.style.display = 'inline-block';
      let pdfGenerated = false; // Track if generation was successful

      try {
        const formData = new FormData(formElement);
        const year = formData.get('year');
        const shortFile = formData.get('short');
        const longFile = formData.get('long');
        const hasHeaders = formData.get('headers') === 'on';
        const isStatic = formData.get('format') === 'static'; // Determine if static (flattened) output needed

        // Basic check for file selection
        let fileError = null;
         if (!shortFile || shortFile.size === 0) fileError = 'Please select the short-term CSV file.';
         if (!longFile || longFile.size === 0) fileError = (fileError ? 'Please select both short-term and long-term CSV files.' : 'Please select the long-term CSV file.');
         if (fileError) throw new Error(fileError);

        console.log('Parsing CSV files...');
        const [shortData, longData] = await Promise.all([
          parseCsv(shortFile, hasHeaders),
          parseCsv(longFile, hasHeaders)
        ]);
        console.log(`Parsed ${shortData.length} short-term rows, ${longData.length} long-term rows.`);
        if (shortData.length === 0 && longData.length === 0) {
            console.warn("Both CSV files resulted in zero data rows after parsing.");
            // Optionally alert the user or proceed to generate blank forms
            // throw new Error("Both CSV files appear to be empty or contain only headers.");
        }

        // --- Fetch Template ---
        const templateUrl = `./forms/f8949--${year}.pdf`;
        console.log(`Fetching template: ${templateUrl}`);
        const response = await fetch(templateUrl);
        console.log(`Fetch response status: ${response.status}`);
         if (!response.ok || response.headers.get('content-type')?.toLowerCase().indexOf('application/pdf') === -1) {
             const errorText = await response.text().catch(() => 'Could not read response body');
             console.error(`Failed to fetch valid PDF template. Status: ${response.status} ${response.statusText}. Response body (might be HTML error page): ${errorText.substring(0, 500)}`);
             throw new Error(`Failed to fetch PDF template for year ${year}. Status: ${response.status} ${response.statusText}. Please ensure '${templateUrl}' exists and is accessible.`);
         }
        const f8949Bytes = await response.arrayBuffer();
        console.log(`Template fetched (${(f8949Bytes.byteLength / 1024).toFixed(1)} KB).`);

        // --- Generate PDF (Fillable or Flattened) ---
        console.log(`Generating ${isStatic ? 'static (flattened)' : 'fillable'} PDF...`);
        // generate8949 now handles both cases based on isStatic flag
        const finalPdfFile = await generate8949(f8949Bytes, year, shortData, longData, isStatic);

        if (finalPdfFile instanceof File) {
            console.log('PDF generated successfully:', finalPdfFile.name);
            download(finalPdfFile);
            pdfGenerated = true; // Mark success
        } else {
             // This case shouldn't really happen if generate8949 resolves correctly
            throw new Error('PDF generation process completed but did not return a valid file object.');
        }

      } catch (error) {
        console.error('Error during form processing:', error);
        // Display a user-friendly message, potentially hiding technical details unless needed
        alert(`An error occurred: ${error.message || 'Unknown error. Please check the browser console for more details.'}`);
        // Optionally provide more specific guidance based on error type if possible

      } finally {
        console.log('Form processing finished. Cleaning up UI...');
        spinner.style.display = 'none';
        formElement.removeAttribute('data-submitting');
        if (pdfGenerated) {
            console.log("PDF download initiated successfully.");
        } else {
             console.log("PDF generation/download did not complete successfully due to errors.");
        }
      }
    });

  </script>
</body>
</html>