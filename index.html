<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:title" content="Fill IRS Form 8949 with CSV">
  <meta property="og:description" content="Web app that fills IRS Form 8949 with data from a CSV file.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://fill-8949.ardis.lu/">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/tslib@1.14.1/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/pako@1.0.11/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/standard-fonts@1.0.0/+esm">
  <link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@pdf-lib/upng@1.0.1/+esm">
  <title>Fill IRS Form 8949 with CSV</title>
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1e3a8a;
      --secondary: #f8fafc;
      --accent: #60a5fa;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #cbd5e1;
      --card-bg: #ffffff;
      --page-bg: #f1f5f9;
      --success: #10b981;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --transition: 0.2s ease-in-out;
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--page-bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem 1rem;
    }

    header {
      margin-bottom: 2rem;
      text-align: center;
    }

    h1 {
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 1.125rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .container {
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 768px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--primary);
      position: relative;
      padding-bottom: 0.75rem;
    }

    .card h2::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 50px;
      background: var(--accent);
      border-radius: 3px;
    }

    .info-card {
      grid-column: 1 / -1;
    }

    .form-card {
      grid-column: 1 / -1;
    }

    .info-section {
      margin-bottom: 1.5rem;
    }

    .info-section:last-child {
      margin-bottom: 0;
    }

    .icon-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.75rem;
      height: 1.75rem;
      background: var(--primary-light);
      color: white;
      border-radius: 50%;
      font-size: 1rem;
    }

    ol {
      padding-left: 1.25rem;
      margin-bottom: 1rem;
    }

    li {
      margin-bottom: 0.75rem;
    }

    li:last-child {
      margin-bottom: 0;
    }

    a {
      color: var(--primary);
      font-weight: 500;
      text-decoration: none;
      transition: color var(--transition), text-decoration-color var(--transition);
      text-underline-offset: 0.2em;
    }

    a:hover, a:focus {
      color: var(--primary-light);
      text-decoration: underline;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 500;
      color: var(--text);
      display: inline-block;
      cursor: pointer;
    }

    select {
      padding: 0.625rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-size: 1rem;
      width: 100%;
      max-width: 200px;
      background-color: var(--secondary);
      cursor: pointer;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .file-input-wrapper {
      position: relative;
      width: 100%;
    }

    .file-input {
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .file-input::file-selector-button {
      padding: 0.625rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background-color: var(--secondary);
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      margin-right: 1rem;
      cursor: pointer;
      transition: background-color var(--transition), border-color var(--transition);
    }

    .file-input::file-selector-button:hover {
      background-color: var(--primary-light);
      color: white;
      border-color: var(--primary-light);
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    input[type="checkbox"] {
      width: 1.25rem;
      height: 1.25rem;
      accent-color: var(--primary);
      cursor: pointer;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition), transform var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      align-self: flex-start;
    }

    button:hover, button:focus {
      background: var(--primary-light);
      transform: translateY(-2px);
    }

    [data-submitting] button {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .download-icon {
      width: 1.25em;
      height: 1.25em;
    }

    .spinner {
      display: none;
      width: 1.25em;
      height: 1.25em;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .source {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.875rem;
      color: var(--text-light);
    }

    @media (max-width: 480px) {
      .card {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>IRS Form 8949 CSV Filler</h1>
      <p class="subtitle">A web tool to automatically fill IRS Form 8949 with your transaction data</p>
    </header>

    <div class="card info-card">
      <h2>How It Works</h2>
      
      <div class="info-section">
        <div class="icon-header">
          <span class="icon">1</span>
          <span>Download CSV Template</span>
        </div>
        <p>Download our CSV template to format your transaction data correctly. The template includes all required columns for Form 8949.</p>
        <p class="file-links">
          <a id="template-link" href="#">
            <svg xmlns="http://www.w3.org/2000/svg" class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            template.csv
          </a>
        </p>
      </div>
      
      <div class="info-section">
        <div class="icon-header">
          <span class="icon">2</span>
          <span>Fill Your Data</span>
        </div>
        <p>Fill the templates with your transaction data - one for short-term transactions and one for long-term transactions.</p>
        <p>You'll need to provide descriptions, acquisition dates, sale dates, proceeds, cost basis, and any adjustment codes from <a href="https://www.irs.gov/form8949" target="_blank">IRS Form 8949 instructions</a>.</p>
      </div>
      
      <div class="info-section">
        <div class="icon-header">
          <span class="icon">3</span>
          <span>Generate Form</span>
        </div>
        <p>Upload your completed CSV files using the form below, select the tax year, and click "Generate Form" to download your filled Form 8949 PDF.</p>
      </div>
      
      <div class="info-section">
        <div class="icon-header">
          <span class="icon">🔒</span>
          <span>Privacy & Security</span>
        </div>
        <p>Your data never leaves your computer. All CSV parsing and PDF filling happens locally in your browser.</p>
      </div>
      
      <div class="info-section">
        <div class="icon-header">
          <span class="icon">⚠️</span>
          <span>Disclaimer</span>
        </div>
        <p>This tool is provided "as is", without warranty of any kind. The author is not responsible for any errors or omissions, or for the results obtained from the use of this tool. This is not legal, accounting, tax, or other professional advice.</p>
      </div>
    </div>

    <div class="card form-card">
      <h2>Generate Your Form</h2>
      <form>
        <div class="form-group">
          <label for="year">Tax Year</label>
          <select id="year" name="year">
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
            <option value="2018">2018</option>
            <option value="2017">2017</option>
            <option value="2016">2016</option>
            <option value="2015">2015</option>
            <option value="2014">2014</option>
            <option value="2013">2013</option>
          </select>
        </div>

        <div class="form-group">
          <label for="short">Short-term Transactions CSV</label>
          <div class="file-input-wrapper">
            <input type="file" id="short" name="short" accept="text/csv" class="file-input" required>
          </div>
        </div>

        <div class="form-group">
          <label for="long">Long-term Transactions CSV</label>
          <div class="file-input-wrapper">
            <input type="file" id="long" name="long" accept="text/csv" class="file-input" required>
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="headers" name="headers" checked>
            <label for="headers">My CSV files include headers</label>
          </div>
        </div>

        <button type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Generate Form 8949
          <span class="spinner"></span>
        </button>
      </form>
    </div>
  </div>

  <footer class="source">
    <a href="https://github.com/ardislu/fill-8949-with-csv" target="_blank">View source code on GitHub</a>
  </footer>

  <script type="module">
    import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
    import { PDFArray, PDFDict, PDFDocument, PDFName, PDFString } from 'https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm';

    const button = document.querySelector('button');
    const spinner = document.querySelector('.spinner');

    // Use a custom id generator instead of crypto.randomUUID() to reduce PDF file size
    const annotationIds = (function* () {
      let i = 0;
      while (true) {
        yield `f${i}`; // Must be unique within the PDF
        i++;
      }
    })();

    // Duplicate all annotations exactly, except for the "T" key. The "T" key ("text label") is used
    // as a unique identifier for the annotation and must be updated or else all annotations with
    // the same "T" key will have the same value.
    // Original code from: https://github.com/Hopding/pdf-lib/issues/151
    function cloneAnnotations(page) {
      const form = page.doc.catalog.lookup(PDFName.of('AcroForm'), PDFDict);
      const fields = form.lookup(PDFName.of('Fields'), PDFArray);
      const annotations = page.node.Annots();
      for (let i = 0; i < annotations.size(); i++) {
        const a = annotations.lookup(i, PDFDict);
        a.set(PDFName.of('T'), PDFString.of(annotationIds.next().value));
        fields.push(a);
      }
    };

    async function generatePage(f8949, data, type) {
      const [page] = type === 'short' ? await f8949.copyPages(f8949, [0]) : await f8949.copyPages(f8949, [1]);
      cloneAnnotations(page);

      let cellNumber = 0;
      const offset = 5; // To skip to the table annotations
      const annots = page.node.Annots();
      for (const row of data) {
        for (const cell of row) {
          const a = annots.lookup(cellNumber + offset, PDFDict);
          a.set(PDFName.of('V'), PDFString.of(cell));
          cellNumber++;
        }
      }

      return page;
    }

    async function generate8949(f8949Bytes, year, shortData, longData) {
      const f8949 = await PDFDocument.load(f8949Bytes);
      const pagePromises = [];
      const chunkSize = 14;
      for (let i = 0; i < shortData.length; i += chunkSize) {
        const chunk = shortData.slice(i, i + chunkSize);
        pagePromises.push(generatePage(f8949, chunk, 'short'));
      }
      if (shortData.length === 0) { // Push a blank page
        pagePromises.push(f8949.copyPages(f8949, [0]).then(p => p[0]));
      }
      for (let i = 0; i < longData.length; i += chunkSize) {
        const chunk = longData.slice(i, i + chunkSize);
        pagePromises.push(generatePage(f8949, chunk, 'long'));
      }
      if (longData.length === 0) { // Push a blank page
        pagePromises.push(f8949.copyPages(f8949, [1]).then(p => p[0]));
      }
      const pages = await Promise.all(pagePromises);

      for (const page of pages) {
        f8949.addPage(page);
      }

      // Remove the original 2 pages of the PDF
      f8949.removePage(0);
      f8949.removePage(0);

      return f8949.save().then(data => new File([data.buffer], `f8949_${year}_filled.pdf`, { type: 'application/pdf' }));
    }

    function download(file) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(file);
      a.download = file.name;
      a.click();
    }

    async function parseCsv(file, hasHeaders) {
      const csv = await new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: false,
          skipEmptyLines: 'greedy',
          complete: resolve,
          error: reject
        });
      });

      const data = csv.data;
      if (hasHeaders) {
        data.shift();
      }
      return data;
    }

    document.querySelector('#template-link').addEventListener('click', e => {
      e.preventDefault();
      const csv = 'Description of property,Date acquired,Date sold or disposed of,Proceeds (sales price),Cost or other basis,Code(s) from instructions,Amount of adjustment,Gain or (loss)';
      const encoded = new TextEncoder().encode(csv);
      const file = new File([encoded], 'template.csv', { type: 'text/csv' });
      download(file);
    });

    document.querySelector('form').addEventListener('submit', async e => {
      e.preventDefault();

      if (e.target.hasAttribute('data-submitting')) {
        return;
      }
      e.target.setAttribute('data-submitting', '');
      spinner.style.display = 'inline-block';

      const form = new FormData(e.target);
      const year = form.get('year');
      const shortFile = form.get('short');
      const longFile = form.get('long');
      const hasHeaders = form.get('headers') === 'on';
      
      try {
        const [f8949Bytes, shortData, longData] = await Promise.all([
          fetch(`/forms/f8949--${year}.pdf`).then(r => r.arrayBuffer()),
          parseCsv(shortFile, hasHeaders),
          parseCsv(longFile, hasHeaders)
        ]);

        await generate8949(f8949Bytes, year, shortData, longData).then(download);
      } catch (error) {
        console.error('Error generating form:', error);
        alert('An error occurred while generating the form. Please check your CSV files and try again.');
      } finally {
        spinner.style.display = 'none';
        e.target.removeAttribute('data-submitting');
      }
    });
  </script>
</body>

</html>